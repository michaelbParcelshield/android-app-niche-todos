# ABOUTME: Runs CI builds and unit tests for the Android app on pushes and PRs.
# ABOUTME: Uses Gradle with JDK 17 to assemble and test the project.
name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"
      - name: Set up Android SDK
        shell: bash
        run: |
          if [ -n "${ANDROID_SDK_ROOT:-}" ] && [ -d "${ANDROID_SDK_ROOT}" ]; then
            echo "Android SDK already present at ${ANDROID_SDK_ROOT}"
            exit 0
          fi

          ANDROID_SDK_ROOT="${HOME}/android-sdk"
          ANDROID_HOME="${ANDROID_SDK_ROOT}"
          mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools"
          curl -fsSL -o /tmp/cmdline-tools.zip \
            https://dl.google.com/android/repository/commandlinetools-linux-12266719_latest.zip
          unzip -q /tmp/cmdline-tools.zip -d "${ANDROID_SDK_ROOT}/cmdline-tools"
          mv "${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools" \
            "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

          set +o pipefail
          yes | "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --licenses
          set -o pipefail
          "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

          {
            echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}"
            echo "ANDROID_HOME=${ANDROID_HOME}"
            echo "PATH=${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${PATH}"
          } >> "${GITHUB_ENV}"
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      - name: Build
        run: ./gradlew assemble
      - name: Unit tests
        run: ./gradlew test
